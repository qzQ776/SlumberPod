# 微信登录接口测试文档

## 接口概述

微信登录接口为SlumberPod枕眠APP提供微信小程序登录功能，支持用户授权登录、登录状态检查和手机号绑定。

## 基础信息

- **服务地址**: `http://localhost:3003`
- **接口前缀**: `/api/wechat`
- **认证方式**: JWT Token (Bearer Token)

## 接口列表

### 1. 微信小程序登录

**接口地址**: `POST /api/wechat/login`

**功能描述**: 通过微信授权码进行用户登录，支持新用户自动注册

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 | 示例值 |
|--------|------|------|------|--------|
| code | string | 是 | 微信小程序登录授权码 | `"023abc123def456ghi789jkl012mno34"` |
| encryptedData | string | 否 | 加密的用户信息数据 | `"CiyLU1Aw2KjvrjMdj8YKliAjtP4gsMZMQmRzooG2xrDcvSnxIMXFufNstNGTyaGS9uT5geRa0W4oTOb1WT7fJlAC+oNPdbB+3hVbJSRgv+4lGOETKUQz6OYStslQ142dNCuabNPGBzlooOmB231qMM85d2/fV6ChevvXvQP8HKKueY1+QIDAQAB"` |
| iv | string | 否 | 加密算法的初始向量 | `"r7BXXKkLb8qrSNn05n0qiA=="` |

**请求示例**:

```json
{
  "code": "023abc123def456ghi789jkl012mno34",
  "encryptedData": "CiyLU1Aw2KjvrjMdj8YKliAjtP4gsMZMQmRzooG2xrDcvSnxIMXFufNstNGTyaGS9uT5geRa0W4oTOb1WT7fJlAC+oNPdbB+3hVbJSRgv+4lGOETKUQz6OYStslQ142dNCuabNPGBzlooOmB231qMM85d2/fV6ChevvXvQP8HKKueY1+QIDAQAB",
  "iv": "r7BXXKkLb8qrSNn05n0qiA=="
}
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| success | boolean | 请求是否成功 |
| message | string | 响应消息 |
| data.token | string | JWT Token，用于后续接口认证 |
| data.user.openid | string | 微信用户唯一标识 |
| data.user.nickname | string | 用户昵称 |
| data.user.avatar_url | string | 用户头像URL |
| data.user.gender | number | 性别（0:未知, 1:男, 2:女） |
| data.user.city | string | 所在城市 |
| data.user.province | string | 所在省份 |
| data.user.country | string | 所在国家 |

**成功响应示例**:

```json
{
  "success": true,
  "message": "微信登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvcGVuaWQiOiJvXzFhQjJjM2Q0ZTUiLCJpYXQiOjE2OTAwMDAwMDAsImV4cCI6MTY5MDYwNDgwMH0.mock_signature",
    "user": {
      "openid": "o_1aB2c3d4e5",
      "nickname": "测试用户",
      "avatar_url": "https://thirdwx.qlogo.cn/mmopen/vi_32/POgEwh4mIHO4nibH0KlMECNjjGxQUq24ZEaGT4poC6icRiccVGKSyXwibcPq4BWmiaIGuG1icwxaQX6grC9VemZoJ8rg/132",
      "gender": 1,
      "city": "深圳市",
      "province": "广东省",
      "country": "中国",
      "created_at": "2024-01-01T00:00:00.000Z",
      "last_login_at": "2024-01-01T12:00:00.000Z"
    }
  }
}
```

**错误响应示例**:

```json
{
  "success": false,
  "message": "微信登录失败: code无效",
  "errorCode": 40029
}
```

### 2. 检查登录状态

**接口地址**: `POST /api/wechat/check-session`

**功能描述**: 验证用户登录状态是否有效

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 | 示例值 |
|--------|------|------|------|--------|
| token | string | 是 | JWT Token | `"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvcGVuaWQiOiJvXzFhQjJjM2Q0ZTUiLCJpYXQiOjE2OTAwMDAwMDAsImV4cCI6MTY5MDYwNDgwMH0.mock_signature"` |

**请求示例**:

```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvcGVuaWQiOiJvXzFhQjJjM3Q0ZTUiLCJpYXQiOjE2OTAwMDAwMDAsImV4cCI6MTY5MDYwNDgwMH0.mock_signature"
}
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| success | boolean | 请求是否成功 |
| message | string | 响应消息 |
| data.user.openid | string | 微信用户唯一标识 |
| data.user.nickname | string | 用户昵称 |
| data.user.avatar_url | string | 用户头像URL |

**成功响应示例**:

```json
{
  "success": true,
  "message": "登录状态有效",
  "data": {
    "user": {
      "openid": "o_1aB2c3d4e5",
      "nickname": "测试用户",
      "avatar_url": "https://thirdwx.qlogo.cn/mmopen/vi_32/POgEwh4mIHO4nibH0KlMECNjjGxQUq24ZEaGT4poC6icRiccVGKSyXwibcPq4BWmiaIGuG1icwxaQX6grC9VemZoJ8rg/132",
      "last_login_at": "2024-01-01T12:00:00.000Z"
    }
  }
}
```

### 3. 绑定手机号

**接口地址**: `POST /api/wechat/bind-phone`

**功能描述**: 绑定用户手机号（需要先登录）

**请求头**:

| 头信息 | 值 | 必填 | 描述 |
|--------|----|------|------|
| Authorization | Bearer {token} | 是 | JWT Token |

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 | 示例值 |
|--------|------|------|------|--------|
| code | string | 是 | 手机号授权码 | `"023abc123def456ghi789jkl012mno34"` |
| encryptedData | string | 是 | 加密的手机号数据 | `"CiyLU1Aw2KjvrjMdj8YKliAjtP4gsMZMQmRzooG2xrDcvSnxIMXFufNstNGTyaGS9uT5geRa0W4oTOb1WT7fJlAC+oNPdbB+3hVbJSRgv+4lGOETKUQz6OYStslQ142dNCuabNPGBzlooOmB231qMM85d2/fV6ChevvXvQP8HKKueY1+QIDAQAB"` |
| iv | string | 是 | 加密算法的初始向量 | `"r7BXXKkLb8qrSNn05n0qiA=="` |

**请求示例**:

```json
{
  "code": "023abc123def456ghi789jkl012mno34",
  "encryptedData": "CiyLU1Aw2KjvrjMdj8YKliAjtP4gsMZMQmRzooG2xrDcvSnxIMXFufNstNGTyaGS9uT5geRa0W4oTOb1WT7fJlAC+oNPdbB+3hVbJSRgv+4lGOETKUQz6OYStslQ142dNCuabNPGBzlooOmB231qMM85d2/fV6ChevvXvQP8HKKueY1+QIDAQAB",
  "iv": "r7BXXKkLb8qrSNn05n0qiA=="
}
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| success | boolean | 请求是否成功 |
| message | string | 响应消息 |
| data.phoneNumber | string | 绑定的手机号 |

**成功响应示例**:

```json
{
  "success": true,
  "message": "手机号绑定成功",
  "data": {
    "phoneNumber": "13800138000"
  }
}
```

## 测试用例

### 测试用例1：微信登录（新用户）

**测试场景**: 新用户首次使用微信登录

**测试步骤**:
1. 调用 `/api/wechat/login` 接口
2. 提供有效的微信授权码
3. 验证返回的用户信息和token

**预期结果**:
- 返回成功响应
- 包含新创建的用户信息
- 返回有效的JWT token

### 测试用例2：微信登录（老用户）

**测试场景**: 已注册用户再次登录

**测试步骤**:
1. 调用 `/api/wechat/login` 接口
2. 提供有效的微信授权码
3. 验证返回的用户信息和token

**预期结果**:
- 返回成功响应
- 包含已有的用户信息
- 更新最后登录时间

### 测试用例3：检查登录状态

**测试场景**: 验证用户登录状态

**测试步骤**:
1. 先通过登录接口获取token
2. 调用 `/api/wechat/check-session` 接口
3. 验证返回的用户信息

**预期结果**:
- 返回登录状态有效
- 包含用户基本信息

### 测试用例4：绑定手机号

**测试场景**: 用户绑定手机号

**测试步骤**:
1. 先通过登录接口获取token
2. 调用 `/api/wechat/bind-phone` 接口
3. 提供手机号授权参数
4. 验证绑定结果

**预期结果**:
- 返回绑定成功
- 包含绑定的手机号

## 错误码说明

| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| 400 | 请求参数错误 | 检查必填参数是否完整 |
| 401 | 未授权访问 | 检查token是否有效 |
| 404 | 用户不存在 | 检查用户是否已注册 |
| 500 | 服务器内部错误 | 检查服务器日志 |

## 微信相关错误码

| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| 40029 | code无效 | 检查code是否正确获取 |
| 45011 | API调用太频繁 | 降低调用频率 |
| 41008 | 缺少code参数 | 检查请求参数 |

## 环境配置

### 微信小程序配置

在 `.env` 文件中配置微信小程序信息：

```env
WECHAT_APPID=your_wechat_appid
WECHAT_SECRET=your_wechat_secret
JWT_SECRET=slumberpod_wechat_secret_key
```

### 测试数据准备

1. **微信授权码**: 通过微信小程序开发工具获取
2. **测试用户**: 系统会自动创建新用户
3. **Token**: 登录成功后自动生成

## 注意事项

1. **安全性**: 微信授权码具有时效性，请及时使用
2. **频率限制**: 微信接口有调用频率限制，请合理控制
3. **数据加密**: 用户敏感信息需要加密传输
4. **Token管理**: JWT token有效期为7天，需要定期刷新
5. **错误处理**: 建议实现完善的错误处理机制

## 调试技巧

1. **日志查看**: 查看服务器控制台日志了解详细流程
2. **参数验证**: 使用Apifox的JSON Schema验证功能
3. **环境切换**: 区分开发环境和生产环境的微信配置
4. **Mock数据**: 在开发阶段可以使用Mock数据进行测试

---

**文档版本**: v1.0  
**最后更新**: 2024-01-01  
**维护人员**: SlumberPod开发团队