# 闹钟系统架构概述

## 🏗️ 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端客户端     │    │   后端API服务    │    │   数据库层      │
│                 │    │                 │    │                 │
│ • 闹钟界面      │◄──►│ • 路由层        │◄──►│ • alarms表     │
│ • 提醒组件      │    │ • 服务层        │    │ • users表       │
│ • 设置页面      │    │ • 数据访问层    │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   提醒服务      │
                    │                 │
                    │ • 定时检查      │
                    │ • 推送通知      │
                    │ • 统计报告      │
                    └─────────────────┘
```

## 📁 文件结构

```
server/
├── routes/
│   ├── alarmRoutes.js           # 基础闹钟管理路由
│   └── alarmReminderRoutes.js   # 闹钟提醒服务路由
├── services/
│   ├── alarmService.js          # 闹钟业务逻辑服务
│   └── alarmReminderService.js  # 闹钟提醒服务
├── database/
│   └── models/
│       └── Alarm.js             # 闹钟数据模型
└── docs/
    └── alarm-api.md             # API文档
```

## 🔧 核心组件

### 1. 数据模型 (Alarm.js)
- 提供基础的数据库操作
- 包含CRUD方法和数据验证
- 与MySQL数据库交互

### 2. 业务服务层 (alarmService.js)
- 业务逻辑处理
- 数据验证和格式化
- 错误处理
- 批量操作支持

### 3. 提醒服务层 (alarmReminderService.js)
- 闹钟触发检查
- 通知发送逻辑
- 统计数据分析
- 备份恢复功能

### 4. 路由层
- API端点定义
- 请求参数验证
- 响应格式化
- 错误处理中间件

## 🚀 功能特性

### 基础功能
- ✅ 创建、读取、更新、删除闹钟
- ✅ 启用/禁用闹钟
- ✅ 重复规则设置
- ✅ 再睡一会功能
- ✅ 振动和音量控制

### 高级功能
- ✅ 批量操作支持
- ✅ 闹钟提醒服务
- ✅ 今日闹钟安排
- ✅ 统计数据分析
- ✅ 设置备份恢复

### 技术特性
- ✅ RESTful API设计
- ✅ JWT认证集成
- ✅ 数据验证和错误处理
- ✅ 模块化架构
- ✅ 完整的文档支持

## 🔄 数据流

### 创建闹钟流程
```
前端请求 → 路由验证 → 服务层处理 → 数据模型 → 数据库存储
```

### 闹钟提醒流程
```
定时检查 → 服务层检查 → 触发条件判断 → 发送通知 → 前端响应
```

## 📊 数据库设计

### alarms表字段说明
| 字段名 | 类型 | 说明 |
|--------|------|------|
| alarm_id | BIGINT | 主键，自增ID |
| openid | VARCHAR(128) | 用户唯一标识 |
| alarm_time | TIME | 闹钟时间 |
| repeat_days | VARCHAR(20) | 重复规则 |
| label | VARCHAR(128) | 闹钟标签 |
| snooze_duration | INT | 再睡一会时长 |
| vibration | TINYINT | 是否振动 |
| volume | INT | 音量设置 |
| is_enabled | TINYINT | 启用状态 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

## 🛡️ 安全特性

### 认证授权
- JWT token验证
- 用户权限检查
- 数据隔离保护

### 数据验证
- 输入参数验证
- SQL注入防护
- 数据类型检查

### 错误处理
- 统一错误响应
- 详细的错误信息
- 安全日志记录

## 📈 性能优化

### 数据库优化
- 索引优化查询
- 连接池管理
- 查询缓存策略

### 服务优化
- 异步处理
- 批量操作
- 缓存机制

## 🔮 扩展计划

### 短期扩展
- [ ] 闹钟铃声自定义
- [ ] 智能跳过节假日
- [ ] 多设备同步

### 长期扩展
- [ ] AI智能提醒
- [ ] 睡眠数据分析
- [ ] 第三方集成

## 🧪 测试覆盖

### 单元测试
- 服务层逻辑测试
- 数据模型测试
- 业务规则验证

### 集成测试
- API端点测试
- 数据库操作测试
- 端到端流程测试

### 性能测试
- 并发用户测试
- 大数据量测试
- 响应时间测试

## 📚 相关文档

- [API接口文档](./docs/alarm-api.md)
- [数据库设计文档](./database/init.js)
- [测试用例文档](../test_alarm_apis.js)