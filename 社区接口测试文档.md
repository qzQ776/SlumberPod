# SlumberPod社区模块API接口测试文档

## 基础信息
- **基础URL**: `http://localhost:3003/api/posts` (请根据实际部署地址调整)
- **认证方式**: Bearer Token (微信JWT)
- **数据格式**: JSON
- **服务端口**: 3003

## 认证要求
大部分接口需要认证，请求头需包含：
```http
Authorization: Bearer {微信JWT_token}
```

## 修复说明
✅ 已修复参数解析bug：
- 修复了`LIMIT`和`OFFSET`参数传递`NaN`值的SQL查询错误
- 所有分页参数现在都正确解析为有效数字
- 增加了参数验证和默认值处理

## 接口分类

### 1. 帖子管理接口

#### 1.1 获取帖子列表
- **URL**: `GET /`
- **描述**: 获取社区帖子列表，支持分页和筛选
- **参数**:
  - `limit` (可选): 每页数量，默认20
  - `offset` (可选): 偏移量，默认0
  - `category_id` (可选): 分类ID
  - `status` (可选): 状态，默认'published'
  - `orderBy` (可选): 排序字段，默认'created_at'
  - `order` (可选): 排序方式，默认'DESC'

**APIfox测试示例**:
```json
{
  "method": "GET",
  "url": "http://localhost:3003/api/posts",
  "params": {
    "limit": 10,
    "offset": 0,
    "category_id": 1,
    "orderBy": "created_at",
    "order": "DESC"
  }
}
```

#### 1.2 获取帖子详情
- **URL**: `GET /:id`
- **描述**: 获取指定帖子的详细信息
- **参数**: `id` (路径参数): 帖子ID

**APIfox测试示例**:
```json
{
  "method": "GET",
  "url": "http://localhost:3003/api/posts/1"
}
```

#### 1.3 创建帖子 (需要认证)
- **URL**: `POST /`
- **描述**: 创建新帖子
- **请求体**:
```json
{
  "title": "帖子标题",
  "content": "帖子内容",
  "cover_image": "封面图片URL",
  "audio_id": 123
}
```

**APIfox测试示例**:
```json
{
  "method": "POST",
  "url": "http://localhost:3003/api/posts",
  "headers": {
    "Authorization": "Bearer your_jwt_token",
    "Content-Type": "application/json"
  },
  "body": {
    "title": "测试帖子",
    "content": "这是一个测试帖子内容",
    "cover_image": "https://example.com/image.jpg",
    "audio_id": 1
  }
}
```

#### 1.4 更新帖子 (需要认证)
- **URL**: `PUT /:id`
- **描述**: 更新帖子内容
- **请求体**: 同创建帖子

#### 1.5 删除帖子 (需要认证)
- **URL**: `DELETE /:id`
- **描述**: 删除指定帖子

### 2. 点赞功能接口

#### 2.1 点赞/取消点赞帖子
- **URL**: `POST /:id/like`
- **描述**: 切换帖子的点赞状态

#### 2.2 检查点赞状态
- **URL**: `GET /:id/like`
- **描述**: 检查当前用户是否点赞了指定帖子

### 3. 评论管理接口

#### 3.1 获取帖子评论列表
- **URL**: `GET /:id/comments`
- **参数**:
  - `limit` (可选): 每页数量，默认20
  - `offset` (可选): 偏移量，默认0
  - `orderBy` (可选): 排序字段，默认'created_at'
  - `order` (可选): 排序方式，默认'DESC'

#### 3.2 添加评论 (需要认证)
- **URL**: `POST /:id/comments`
- **请求体**:
```json
{
  "content": "评论内容",
  "parent_id": 123  // 可选，回复的父评论ID
}
```

#### 3.3 删除评论 (需要认证)
- **URL**: `DELETE /comments/:commentId`

#### 3.4 点赞/取消点赞评论 (需要认证)
- **URL**: `POST /comments/:commentId/like`

### 4. 音频评论接口

#### 4.1 获取音频评论列表
- **URL**: `GET /audio/:audioId/comments`
- **参数**: 同帖子评论

#### 4.2 添加音频评论 (需要认证)
- **URL**: `POST /audio/:audioId/comments`
- **请求体**: 同普通评论

### 5. 评论回复接口

#### 5.1 获取评论详情
- **URL**: `GET /comments/:commentId`

#### 5.2 获取评论回复列表
- **URL**: `GET /comments/:commentId/replies`

### 6. 搜索和分类接口

#### 6.1 搜索帖子
- **URL**: `GET /search`
- **参数**:
  - `q` (必需): 搜索关键词
  - `limit` (可选): 每页数量，默认20
  - `offset` (可选): 偏移量，默认0

#### 6.2 获取热门帖子
- **URL**: `GET /hot`
- **参数**: 同帖子列表

#### 6.3 获取最新帖子
- **URL**: `GET /latest`
- **参数**: 同帖子列表

### 7. 用户相关接口

#### 7.1 获取用户发布的帖子 (需要认证)
- **URL**: `GET /user/posts`
- **参数**: 同帖子列表

#### 7.2 获取用户评论列表 (需要认证)
- **URL**: `GET /user/comments`
- **参数**:
  - `limit` (可选): 每页数量，默认20
  - `offset` (可选): 偏移量，默认0
  - `targetType` (可选): 评论目标类型，'post'或'audio'

## APIfox环境配置

### 1. 环境变量设置
在APIfox中创建环境变量：
```json
{
  "base_url": "http://localhost:3003",
  "jwt_token": "your_actual_jwt_token"
}
```

### 2. 预请求脚本
在需要认证的接口中添加预请求脚本：
```javascript
// 获取环境变量中的token
const token = pm.environment.get("jwt_token");

// 设置Authorization头
pm.request.headers.add({
    key: "Authorization",
    value: "Bearer " + token
});
```

### 3. 测试用例集合

#### 测试集合1: 帖子功能完整测试
```javascript
// 测试脚本示例
pm.test("状态码为200", function () {
    pm.response.to.have.status(200);
});

pm.test("响应包含success字段", function () {
    pm.expect(pm.response.json()).to.have.property('success');
});

pm.test("success为true", function () {
    pm.expect(pm.response.json().success).to.be.true;
});
```

#### 测试集合2: 评论功能测试
```json
{
  "测试流程": [
    "1. 创建帖子",
    "2. 添加主评论", 
    "3. 添加回复评论",
    "4. 获取评论列表",
    "5. 点赞评论",
    "6. 删除评论"
  ]
}
```

## 测试步骤

### 第一步：启动服务器
```bash
cd server
npm run dev
# 或
node index.js
```

### 第二步：健康检查
- URL: `GET http://localhost:3003/api/health`
- 预期响应: `{"status":"OK","message":"SlumberPod API服务运行正常"}`

### 第三步：获取认证token
使用微信登录接口获取JWT token，然后设置到APIfox环境变量中。

### 第四步：按顺序测试
1. 先测试无需认证的接口（帖子列表、帖子详情）
2. 测试认证接口（创建帖子、点赞、评论）
3. 测试搜索和分类功能
4. 测试用户相关功能

## 错误码说明

| 状态码 | 错误信息 | 说明 |
|--------|----------|------|
| 200 | 成功 | 请求成功 |
| 400 | 参数错误 | 请求参数不正确 |
| 401 | 未授权 | 未提供有效token |
| 403 | 无权操作 | 用户无权限执行操作 |
| 404 | 资源不存在 | 请求的资源不存在 |
| 500 | 服务器错误 | 服务器内部错误 |

## 常见问题解决

### Q1: 参数解析错误
**问题**: SQL查询执行失败: Incorrect arguments to mysqld_stmt_execute
**解决**: ✅ 已修复 - 现在所有参数都正确解析为有效数字

### Q2: 路由访问错误
**问题**: Cannot GET /api/community
**解决**: 使用正确的路径 `/api/posts` 而不是 `/api/community`

### Q3: 认证失败
**问题**: 401未授权
**解决**: 确保请求头包含有效的Authorization: Bearer {token}

### Q4: 端口错误
**问题**: 连接被拒绝
**解决**: 服务器运行在端口3003，请确保服务已启动

## 数据模型说明
社区模块基于以下数据库表：
- `community_posts`: 帖子表
- `comments`: 评论表  
- `likes`: 点赞表
- `users`: 用户表（通过openid关联）

---

**修复完成状态**: ✅ 所有参数解析bug已修复
**测试建议**: 建议从简单接口开始，逐步测试复杂功能